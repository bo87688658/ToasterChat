<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ToasterChat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>

  .public-item{
  padding:8px;
  background:#1a1a22;
  border-radius:8px;
  margin-bottom:6px;
  cursor:pointer;
}
.public-item:hover{
  background:#222;
}

:root{
  --bg:#0b0b12;
  --panel:#111;
  --accent:#ffb703;
}

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
}

body {
  font-family: "Jost", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  height: 100vh;
  background: var(--bg);
  overflow: hidden;
}

/* ===== SCREENS ===== */
#screen {
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
}

.card{
  background:#111;
  padding:20px;
  width:320px;
  border-radius:12px;
}

.hidden{display:none}

/* CHAT */
#app {
  display: none; /* come√ßa escondido */
}

#app.active {
  display: flex;
  position: fixed;       /* fullscreen quando ativo */
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  flex-direction: column;
  background: var(--bg);
  z-index: 1;
}

.topbar {
  height: 48px;
  background: #111;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 12px;
  flex-shrink: 0;
}

.main {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.sidebar {
  width: 220px;
  background: #111;
  padding: 10px;
  overflow-y: auto;
}

.chat {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.msg {
  display: flex;
  gap: 8px;
  align-items: flex-start;
}

.avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  background: #222;
}

.msg-content {
  flex: 1;
}

.msg-user {
  font-weight: bold;
  font-size: 13px;
}

.msg:hover {
  background: #1a1a22;
}

.reply-box {
  font-size: 12px;
  opacity: .7;
  border-left: 3px solid var(--accent);
  padding-left: 6px;
  margin-bottom: 4px;
  cursor: pointer;
}

.input {
  display: flex;
  gap: 6px;
  padding: 8px;
  background: #111;
}

input, button {
  padding: 8px;
  border: none;
  border-radius: 8px;
}

button {
  cursor: pointer;
  background: var(--accent);
}

input {
  width: 100%;
}

/* ===== CHANNEL ===== */
.channel {
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
}
.channel.active {
  background: #1a1a22;
}

/* ===== SETTINGS & MODALS ===== */
#settings{
  position:fixed;
  inset:0;
  background:#000;
  z-index:10;
  display:none;
}
.settings-panel{padding:20px}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal-box{
  background:#111;
  padding:20px;
  width:360px;
  border-radius:14px;
}
.modal-box h3{margin-bottom:10px}
.modal-box p{font-size:14px;opacity:.8;margin-bottom:10px}
.modal-box input, .modal-box textarea{
  width:100%;
  background:#0b0b12;
  color:#0f0;
  font-family:monospace;
}
.modal-actions{
  display:flex;
  gap:8px;
  margin-top:12px;
}
.modal-actions button{
  flex:1;
}

/* For√ßa todos os textos dentro do chat para branco */
#app, #app * {
  color: #fff;
}

/* Barra de reply acima do input */
.replying-bar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #222;
  padding: 4px 8px;
  font-size: 12px;
  border-left: 4px solid var(--accent);
}

.replying-bar span {
  color: #fff;
}

.replying-bar button {
  background: transparent;
  border: none;
  color: #ff6b6b;
  cursor: pointer;
  font-weight: bold;
}
body, #app, #screen {
  color: #fff; /* branco apenas para textos normais */
}
input, textarea {
  color: #000000; /* texto do usu√°rio dentro do input */
  background: #ffffff; /* fundo escuro */
}

input::placeholder, textarea::placeholder {
  color: #ccc; /* placeholder mais claro */
}
.chat .input {
  display: flex;
  gap: 6px;
  padding: 8px;
  background: #111; /* fundo escuro */
}

.chat .input input {
  flex: 1;
  padding: 8px;
  border-radius: 8px;
  border: none;
  background: #fff; /* fundo do input */
  color: #000;      /* texto dentro do input */
}

.chat .input input::placeholder {
  color: #888; /* placeholder mais claro */
}

.chat .input button {
  color: #000;      /* texto preto */
  /* mant√©m todas as outras propriedades */
  padding: 8px 12px;
  border-radius: 8px;
  border: none;
  background: var(--accent); /* mant√©m a cor de fundo */
  cursor: pointer;
}

/* ===== FIX INPUT E BOT√ÉO SEND ===== */
.chat .input input {
  background: #ffffff !important;
  color: #000000 !important;
}

.chat .input input::placeholder {
  color: #666 !important;
}

.chat .input button {
  background: var(--accent);
  color: #000000 !important;
  font-weight: bold;
}

input,
textarea,
button {
  font-family: "Jost", system-ui, sans-serif;
}
.hidden {
  display: none !important;
}

#app.active {
  display: flex !important;
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  background: var(--bg);
}

#screen.hidden {
  display: none !important;
}
.main {
  flex: 1;
  min-height: 0;
}

.messages {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}
.media-btn{
  background:#222;
  color:#fff;
  font-size:18px;
  width:40px;
}

.media-bar{
  display:flex;
  gap:6px;
  padding:6px;
  background:#1a1a22;
  border-left:4px solid var(--accent);
  overflow-x:auto;
}

.media-item{
  position:relative;
  background:#000;
  border-radius:8px;
  padding:4px;
}

.media-item img,
.media-item video{
  max-width:80px;
  max-height:60px;
  border-radius:6px;
}

.media-item audio{
  width:140px;
}

.media-remove{
  position:absolute;
  top:-6px;
  right:-6px;
  background:#ff4d4d;
  border:none;
  color:#fff;
  border-radius:50%;
  width:18px;
  height:18px;
  font-size:12px;
  cursor:pointer;
}
/* ===== MOBILE UI ===== */
@media (max-width: 768px) {

  /* layout geral */
  #app.active {
    height: 100dvh;
  }

  .topbar {
    height: 52px;
    font-size: 16px;
  }

  .main {
    flex-direction: column;
  }

  /* ===== SIDEBAR vira drawer ===== */
  .sidebar {
    position: fixed;
    top: 52px;
    left: -260px;
    width: 240px;
    height: calc(100% - 52px);
    z-index: 20;
    transition: left .25s ease;
    background: #111;
  }

  .sidebar.open {
    left: 0;
  }

  /* bot√£o menu */
  .menu-btn {
    background: none;
    color: #fff;
    font-size: 20px;
  }

  /* chat ocupa tudo */
  .chat {
    width: 100%;
  }

  .messages {
    padding: 10px 8px;
  }

  /* mensagens */
  .msg {
    gap: 6px;
    margin-bottom: 10px;
  }

  .avatar {
    width: 32px;
    height: 32px;
  }

  .msg-user {
    font-size: 12px;
  }

  /* ===== INPUT MOBILE ===== */
  .chat .input {
    padding: 10px;
    gap: 8px;
  }

  .chat .input input {
    font-size: 16px; /* evita zoom no iOS */
    height: 42px;
  }

  .chat .input button {
    height: 42px;
    min-width: 44px;
  }

  .media-btn {
    width: 42px;
    height: 42px;
    font-size: 20px;
  }

  /* ===== REPLY BAR ===== */
  .replying-bar {
    font-size: 12px;
    padding: 6px 8px;
  }

  /* ===== MEDIA BAR ===== */
  .media-bar {
    padding: 6px;
    gap: 6px;
  }

  .media-item img,
  .media-item video {
    max-width: 100px;
    max-height: 80px;
  }
}

</style>
</head>

<body>

<div id="screen">

<!-- LOGIN / REGISTER -->

<!-- HOME -->
<div class="card hidden" id="home">
  <h3>Welcome</h3><br>
  <button onclick="showCreate()">‚ûï Create server</button><br><br>
  <button onclick="showJoin()">üîë Join server</button><br><br>
  <button onclick="openSettings()">‚öôÔ∏è Settings</button>
  <button onclick="openPublicServers()">üåç Public Servers</button><br><br>
</div>

<div class="card" id="auth">
  <h3>Account</h3><br>
  <input id="authNameInput" placeholder="Name"><br><br>
  <input id="authIconInput" placeholder="Icon URL (Optional)"><br><br>
  <button onclick="register()">Sign-up</button>
  <br><br>
  <button onclick="login()">Login</button>
</div>

<!-- CREATE SERVER -->
<div class="card hidden" id="create">
  <input id="srvNameInput" placeholder="Server Name"><br><br>
  <input id="srvPSGInput" placeholder="Server PSG"><br><br>
  <input id="srvIconInput" placeholder="Server Icon"><br><br>
  <button type="button" onclick="createServer()">Create</button>
</div>

<!-- JOIN SERVER -->
<div class="card hidden" id="join">
  <input id="joinPSGInput" placeholder="Server PSG"><br><br>
  <button onclick="joinServer()">Enter</button>
</div>


</div>

<!-- CHAT -->
<div id="app" class="hidden">
<div class="topbar">
  <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
  <b id="srvTitle"></b>
  <button onclick="openSettings()">‚öôÔ∏è</button>
</div>

  <div class="main">
    <div class="sidebar" id="channels"></div>

    <div class="chat">
      <div class="messages" id="messages"></div>

      <div id="replyingBar" class="replying-bar hidden">
        <span id="replyingText"></span>
        <button onclick="cancelReply()">‚úñ</button>
      </div>

      <div id="mediaBar" class="media-bar hidden"></div>

      <div class="input">
        <button class="media-btn" onclick="openMedia()">‚ûï</button>
        <input id="mediaInput" type="file" multiple
          accept="image/*,video/*,audio/*,.gif" hidden
          onchange="handleMedia(this.files)">
        <input id="text" placeholder="Message">
        <button onclick="send()">Send</button>
      </div>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="settings">
  <div class="settings-panel">
    <h2>Settings</h2><br>
    <button onclick="settingsTab('account')">Account</button>
    <button onclick="settingsTab('theme')">Theme</button>
    <br><br>

    <div id="setAccount">
      <input id="setName"><br><br>
      <input id="setIcon"><br><br>
      <button onclick="saveAccount()">Save</button><br><br>
      <button onclick="logout()">Change account</button><br><br>
      <button onclick="deactivate()" style="background:red">Disable account</button>
    </div>

    <div id="setTheme" class="hidden">
      <button onclick="setTheme('#0b0b12')">Dark</button>
      <button onclick="setTheme('#f5f5f5')">Bright</button>
    </div>

    <br>
    <button onclick="closeSettings()">Close</button>
  </div>
</div>

<div class="modal" id="publicModal">
  <div class="modal-box">
    <h3>üåç Public Servers</h3>
    <div id="publicList" style="max-height:260px;overflow:auto"></div>
    <div class="modal-actions">
      <button onclick="closePublic()">Close</button>
    </div>
  </div>
</div>

<script>
let server = {
  name: "Untitled",
  psg: "",
  icon: "",
  channels: {
    "General": [],
    "Off-topic": []
  }
}
let directoryPeer;
let directoryConn;


const screen = document.getElementById("screen")
const auth = document.getElementById("auth")
const home = document.getElementById("home")
const create = document.getElementById("create")
const join = document.getElementById("join")
const app = document.getElementById("app")
const srvTitle = document.getElementById("srvTitle")
const channels = document.getElementById("channels")
const messages = document.getElementById("messages")
const text = document.getElementById("text")


/* ===== STORAGE ===== */
const authName = document.getElementById("authNameInput")
const authIcon = document.getElementById("authIconInput")
const srvName = document.getElementById("srvNameInput")
const srvPSG = document.getElementById("srvPSGInput")
const srvIcon = document.getElementById("srvIconInput")
const joinPSG = document.getElementById("joinPSGInput")

const db={
  get:k=>JSON.parse(localStorage.getItem(k)),
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
  del:k=>localStorage.removeItem(k)
}

/* ===== HASH ===== */
async function sha256(t){
  const b=new TextEncoder().encode(t)
  const h=await crypto.subtle.digest("SHA-256",b)
  return [...new Uint8Array(h)].map(x=>x.toString(16).padStart(2,"0")).join("")
}
function enterChat() {
  // ESCONDE TODAS AS TELAS DE MENU
  screen.classList.add("hidden");

  // MOSTRA CHAT FULLSCREEN
  app.classList.add("active");
  app.classList.remove("hidden");

  srvTitle.textContent = server?.name || "Server";
  renderChannels();
}

function psgToPeer(psg){
  return psg.replace(/[^a-zA-Z0-9_-]/g, "_");
}

/* ===== ACCOUNT ===== */
let account=db.get("account")
if(account) showHome()
async function register(){
  const name=authName.value||"Account"
  const icon=authIcon.value||"https://i.imgur.com/a/3VwiEAH.png"

  const psk="PSK://DO-NOT-SHARE-THIS/"+crypto.randomUUID()
  const hash=await sha256(psk)

  account={name,icon,hash}
  db.set("account",account)

  pskValue.value=psk
  pskModal.style.display="flex"
}
function copyPSK(){
  pskValue.select()
  document.execCommand("copy")
}
function closePSK(){
  pskModal.style.display="none"
  showHome()
}
function login(){
  loginPSK.value=""
  loginModal.style.display="flex"
}
function showError(t){
  errorText.textContent=t
  errorModal.style.display="flex"
}
function closeError(){
  errorModal.style.display="none"
}
async function doLogin(){
  const psk=loginPSK.value
  if(!psk.startsWith("PSK://DO-NOT-SHARE-THIS/")){
    return showError("Invalid PSK")
  }
  const hash=await sha256(psk)
  const acc=db.get("account")
  if(acc && acc.hash===hash){
    account=acc
    loginModal.style.display="none"
    showHome()
  }else{
    showError("Incorrect PSK")
  }
}
function closeLogin(){
  loginModal.style.display="none"
}
/* ===== UI FLOW ===== */
function showHome(){
  auth.classList.add("hidden")
  home.classList.remove("hidden")
}
function showCreate(){
  home.classList.add("hidden")
  create.classList.remove("hidden")
}
function showJoin(){
  home.classList.add("hidden")
  join.classList.remove("hidden")
}

/* ===== REPLY STUFF ===== */
let replying = null;
const replyingBar = document.getElementById("replyingBar");
const replyingText = document.getElementById("replyingText");

function updateReplyBar() {
  if (replying) {
    replyingText.textContent = `You are replying to @${replying.user}`;
    replyingBar.classList.remove("hidden");
  } else {
    replyingText.textContent = "";
    replyingBar.classList.add("hidden");
  }
}

// come√ßa invis√≠vel
updateReplyBar();

function setReply(msg) {
  replying = msg;
  updateReplyBar();
}

function cancelReply() {
  replying = null;
  updateReplyBar();
}

let mediaFiles = [];
const mediaBar = document.getElementById("mediaBar");
const mediaInput = document.getElementById("mediaInput");

function openMedia(){
  mediaInput.click();
}

function handleMedia(files){
  [...files].forEach(file=>{
    const reader = new FileReader();

    reader.onload = e=>{
      mediaFiles.push({
        id: crypto.randomUUID(),
        name: file.name,
        type: file.type,
        data: e.target.result // ‚úÖ BASE64
      });
      renderMediaBar();
    };

    reader.readAsDataURL(file); // üî• BASE64 REAL
  });

  mediaInput.value = ""; // reset obrigat√≥rio
}

function renderMediaBar(){
  mediaBar.innerHTML = "";

  if(mediaFiles.length === 0){
    mediaBar.classList.add("hidden");
    mediaInput.value = "";
    return;
  }

  mediaBar.classList.remove("hidden");

  mediaFiles.forEach(m=>{
    const box = document.createElement("div");
    box.className = "media-item";

    let el;
    if(m.type.startsWith("image")){
      el = document.createElement("img");
      el.src = m.data;
    }else if(m.type.startsWith("video")){
      el = document.createElement("video");
      el.src = m.data;
      el.controls = true;
    }else if(m.type.startsWith("audio")){
      el = document.createElement("audio");
      el.src = m.data;
      el.controls = true;
    }

    const remove = document.createElement("button");
    remove.className = "media-remove";
    remove.textContent = "‚úñ";
    remove.onclick = ()=>{
      mediaFiles = mediaFiles.filter(x=>x.id!==m.id);
      renderMediaBar();
    };

    box.appendChild(el);
    box.appendChild(remove);
    mediaBar.appendChild(box);
  });
}

// Atualiza a fun√ß√£o do click em renderMessages
function renderMessages(){
  messages.innerHTML = "";

  server.channels[channel].forEach(m => {
    const wrap = document.createElement("div");
    wrap.className = "msg";
    wrap.id = m.id;

    /* AVATAR */
    const avatar = document.createElement("img");
    avatar.className = "avatar";
    avatar.src = m.icon || "https://i.imgur.com/FGE8gTE.png";
    avatar.onerror = () => avatar.src = "https://i.imgur.com/FGE8gTE.png";

    /* CONTE√öDO */
    const content = document.createElement("div");
    content.className = "msg-content";

    /* REPLY */
    if(m.reply){
      const r = document.createElement("div");
      r.className = "reply-box";
      r.textContent = `‚Ü™ ${m.reply.user}: ${m.reply.text}`;
      r.onclick = e=>{
        e.stopPropagation();
        document.getElementById(m.reply.id)?.scrollIntoView();
      };
      content.appendChild(r);
    }

    /* USER */
    const user = document.createElement("div");
    user.className = "msg-user";
    user.textContent = m.user;
    content.appendChild(user);

    /* TEXTO (S√ì SE EXISTIR) */
    if(m.text && m.text.trim() !== ""){
      const txt = document.createElement("div");
      txt.textContent = m.text;
      content.appendChild(txt);
    }

    /* M√çDIA BASE64 (UMA √öNICA VEZ) */
    if(m.media){
      m.media.forEach(md=>{
        let el;

        if(md.type.startsWith("image")){
          el = document.createElement("img");
          el.src = md.data;
          el.style.maxWidth = "220px";
          el.style.borderRadius = "8px";

        }else if(md.type.startsWith("video")){
          el = document.createElement("video");
          el.src = md.data;
          el.controls = true;
          el.style.maxWidth = "240px";

        }else if(md.type.startsWith("audio")){
          el = document.createElement("audio");
          el.src = md.data;
          el.controls = true;
        }

        if(el) content.appendChild(el);
      });
    }

    wrap.appendChild(avatar);
    wrap.appendChild(content);
    wrap.onclick = ()=>setReply(m);
    messages.appendChild(wrap);
  });

  messages.scrollTop = messages.scrollHeight;
}

/* ===== SERVER ===== */
let peer, conns={}, channel="General"
let messagesData={}

function createServer(){
  let psg = srvPSG.value.trim();

  // üåç se vazio, vira p√∫blico automaticamente
  if(psg === ""){
    psg = "public/" + Math.floor(100000 + Math.random()*900000);
  }

  server = {
    name: srvName.value || "Server",
    psg: psg,
    icon: srvIcon.value || "",
    channels: {
      "General": [],
      "Off-topic": []
    }
  };

  channel = "General";

  // inicia Peer com ID seguro
  startPeer(psgToPeer(server.psg) + "-host");

  // host entra direto no chat
  enterChat();

  // se for p√∫blico, anuncia e envia mensagem de system
  if(server.psg.startsWith("public/")){
    announcePublicServer();

    const msg = {
      id: crypto.randomUUID(),
      user: "System",
      text: `üåç This is a public server. PSG: ${server.psg}`,
      media: [],
      reply: null
    };

    server.channels[channel].push(msg);
    renderMessages();
  }
}

function startPeer(id){
  peer = new Peer(id);

  peer.on("connection", c => {
    conns[c.peer] = c;

    c.on("data", handle);
  });
}


function joinServer(){
  const base = joinPSG.value.trim();
  if(!base) return alert("Invalid PSG");

const safe = psgToPeer(base);
const hostId = safe + "-host";
const myId = safe + "-" + crypto.randomUUID().slice(0,5);

  startPeer(myId);

  peer.on("open", () => {
    const c = peer.connect(hostId, { reliable: true });

    let ok = false;

    const timeout = setTimeout(() => {
      if(!ok){
        alert("Server not found/You are offline");
        location.reload();
      }
    }, 4000);

    c.on("open", () => {
      conns[hostId] = c;
      c.send({ type: "hello" }); // üî• pede sync
    });

    c.on("data", d => {
      if(d.type === "sync"){
        ok = true;
        clearTimeout(timeout);
        server = d.server;
        enterChat(); // üî• agora sim
      }
      handle(d);
    });

    c.on("error", () => {
      alert("Error on connecting");
      location.reload();
    });
  });
}

/* ===== CHAT ===== */
function renderChannels(){
  channels.innerHTML=""
  Object.keys(server.channels).forEach(c=>{
    const d=document.createElement("div")
    d.textContent="# "+c
    d.className="channel"+(c===channel?" active":"")
    d.onclick = () => {
      channel = c;
      renderChannels();
      renderMessages();

      // FECHA SIDEBAR NO MOBILE
      document.querySelector(".sidebar")?.classList.remove("open");
    };
    channels.appendChild(d)
  })
  renderMessages()
}
function send(){
  if(!text.value && mediaFiles.length === 0) return;

  const msg = {
    id: crypto.randomUUID(),
    user: account.name,
    text: text.value,
    reply: replying,
    media: mediaFiles.map(m=>({
      name: m.name,
      type: m.type,
      data: m.data // ‚úÖ BASE64
    }))
  };

  server.channels[channel].push(msg);
  broadcast(msg);

  text.value = "";
  mediaFiles = [];
  mediaInput.value = "";
  renderMediaBar();
  cancelReply();
  renderMessages();
}

function broadcast(m){
  Object.values(conns).forEach(c=>c.send({type:"msg",channel,msg:m}))
}
function handle(d){
  // HOST recebe hello
  if(d.type === "hello"){
    const c = conns[this.peer] || Object.values(conns).find(x => x.peer === this.peer);
    if(c){
      c.send({
        type: "sync",
        server
      });
    }
    return;
  }

  if(d.type === "sync"){
    server = d.server;
    enterChat(); // üî• ENTRA S√ì AQUI
    return;
  }

  if(d.type === "msg"){
    server.channels[d.channel].push(d.msg);
    renderMessages();
  }
}

/* ===== SETTINGS ===== */
function openSettings(){
  settings.style.display="block"
  setName.value=account.name
  setIcon.value=account.icon
}
function closeSettings(){settings.style.display="none"}
function settingsTab(t){
  setAccount.classList.toggle("hidden",t!=="account")
  setTheme.classList.toggle("hidden",t!=="theme")
}
function saveAccount(){
  account.name=setName.value
  account.icon=setIcon.value
  db.set("account",account)
}
function logout(){
  location.reload()
}
function deactivate(){
  if(confirm("This is irreversible. Continue?")){
    db.del("account")
    location.reload()
  }
}
function setTheme(bg){
  document.documentElement.style.setProperty("--bg",bg)
}
function systemMessage(text){
  const msg = {
    id: crypto.randomUUID(),
    user: "System",
    text,
    system: true
  };

  server.channels[channel].push(msg);
  renderMessages();
}

// ===== EXPOSE TO HTML =====
Object.assign(window, {
  register,
  login,
  doLogin,
  copyPSK,
  closePSK,
  closeLogin,
  closeError,
  showCreate,
  showJoin,
  openSettings,
  closeSettings,
  settingsTab,
  saveAccount,
  logout,
  deactivate,
  setTheme,
  send,
  cancelReply,
  createServer,
  joinServer
});
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("open");
}
function toggleSidebar(){
  document.querySelector(".sidebar").classList.toggle("open");
}
function announcePublicServer(){
  const p = new Peer();

  p.on("open", ()=>{
    const c = p.connect("public-directory");

    const send = ()=>{
      c.send({
        type:"announce",
        server:{
          name: server.name,
          psg: server.psg,
          icon: server.icon
        }
      });
    };

    c.on("open", ()=>{
      send();
      setInterval(send, 10000); // üîÑ a cada 10s
    });
  });
}
function openPublicServers(){
  publicModal.style.display="flex";
  publicList.innerHTML = "Loading...";

  const p = new Peer();

  p.on("open", ()=>{
    const c = p.connect("public-directory");

    c.on("open", ()=>{
      c.send({type:"list"});
    });

    c.on("data", d=>{
      if(d.type==="list"){
        renderPublicList(d.servers);
      }
    });
  });
}

function closePublic(){
  publicModal.style.display="none";
}
function renderPublicList(list){
  publicList.innerHTML = "";

  if(list.length === 0){
    publicList.textContent = "No public servers online";
    return;
  }

  list.forEach(s=>{
    const div = document.createElement("div");
    div.className = "public-item";
    div.textContent = s.name || "Unnamed server";

div.onclick = ()=>{
  joinPSG.value = s.psg;
  closePublic();
  joinServer();
};

    publicList.appendChild(div);
  });
}

// ===== PUBLIC DIRECTORY (TRACKER) =====
let directory = {};
let directoryHost = null;

try{
  directoryHost = new Peer("public-directory");

  directoryHost.on("open", ()=>{
    console.log("üåç Public directory online");
  });

  directoryHost.on("connection", c=>{
    c.on("data", d=>{

      // servidor anuncia
      if(d.type === "announce"){
        directory[c.peer] = {
          ...d.server,
          time: Date.now()
        };
      }

      // cliente pede lista
      if(d.type === "list"){
        const now = Date.now();

        // remove servidores mortos
        Object.keys(directory).forEach(k=>{
          if(now - directory[k].time > 30000){
            delete directory[k];
          }
        });

        c.send({
          type: "list",
          servers: Object.values(directory)
        });
      }
    });
  });

}catch(e){
  console.log("Directory already running");
}

</script>

</body>
<!-- MODAL PSK -->
<div class="modal" id="pskModal">
  <div class="modal-box">
    <h3>‚ö†Ô∏è YOUR PSK</h3>
    <p>Save this code, its your password.</p>
    <textarea id="pskValue" rows="3" readonly></textarea>
    <div class="modal-actions">
      <button onclick="copyPSK()">Copy</button>
      <button onclick="closePSK()">Continue</button>
    </div>
  </div>
</div>

<!-- MODAL LOGIN -->
<div class="modal" id="loginModal">
  <div class="modal-box">
    <h3>Login</h3>
    <p>Paste your PSK</p>
    <input id="loginPSK">
    <div class="modal-actions">
      <button onclick="doLogin()">Enter</button>
      <button onclick="closeLogin()">Cancel</button>
    </div>
  </div>
</div>

<!-- MODAL ERROR -->
<div class="modal" id="errorModal">
  <div class="modal-box">
    <h3>Error</h3>
    <p id="errorText"></p>
    <div class="modal-actions">
      <button onclick="closeError()">OK</button>
    </div>
  </div>
</div>
</html>
